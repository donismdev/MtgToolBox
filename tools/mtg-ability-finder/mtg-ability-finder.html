<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>MTG Ability Finder</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
	<style>
		body {
			padding: 2rem;
			background-color: #f4f4f4;
			font-family: system-ui, sans-serif;
		}
		#searchSection {
			max-width: 800px;
			margin: 0 auto;
		}
		#abilityInput {
			font-size: 1.5rem;
			padding: 1rem;
			height: 4rem;
		}
		#abilityList {
			margin-top: 2rem;
			display: flex;
			flex-wrap: wrap;
			gap: 0.5rem;
			justify-content: center;
		}
		.ability-badge {
			padding: 0.6rem 1rem;
			background-color: #e0e0e0;
			border-radius: 1rem;
			cursor: pointer;
			font-weight: 500;
			transition: background-color 0.2s;
		}
		.ability-badge:hover {
			background-color: #c0c0c0;
		}
		#divider {
			margin: 3rem 0 1rem 0;
			border-bottom: 2px solid #bbb;
		}
		#abilityDetails {
			display: none;
			margin-top: 2rem;
			text-align: center;
		}
		#resetBtn {
			margin-top: 1.5rem;
		}
	</style>
</head>
<body>
	<div id="searchSection">
		<input type="text" id="abilityInput" class="form-control mb-3" placeholder="Enter MTG ability keyword (e.g., trample, flash)" oninput="filterAbilities()" list="abilitySuggestions" />
		<datalist id="abilitySuggestions"></datalist>
		<div id="divider"></div>
		<div id="abilityList"></div>
		<div id="abilityDetails">
			<h2 id="selectedAbility"></h2>
			<p id="abilityText" class="mt-3"></p>
			<button class="btn btn-secondary" id="resetBtn" onclick="resetView()">Reset</button>
		</div>
	</div>

<script>
const abilityList = document.getElementById("abilityList");
const abilityInput = document.getElementById("abilityInput");
const abilitySuggestions = document.getElementById("abilitySuggestions");
const abilityDetails = document.getElementById("abilityDetails");
const selectedAbility = document.getElementById("selectedAbility");
const abilityText = document.getElementById("abilityText");

let abilities = {};
window.mtgData = {};

fetch('abilities/ability_data.json')
	.then(res => res.json())
	.then(data => {
		window.mtgData = data;

		abilities = {
			...data.abilities,
			...data.evergreen,
			...data.arena
		};

		// ✅ special은 일관된 객체 형태로 병합
		Object.entries(data.special).forEach(([name, text]) => {
			abilities[name] = {
				text: text,
				type: "special"
			};
		});

		renderAbilityList();
	});

function renderAbilityList() {
	abilityList.innerHTML = "";
	abilitySuggestions.innerHTML = "";
	Object.keys(abilities).forEach(name => {
		const badge = document.createElement("div");
		badge.className = "ability-badge";
		badge.innerText = name;
		badge.onclick = () => showAbility(name);
		abilityList.appendChild(badge);

		const option = document.createElement("option");
		option.value = name;
		abilitySuggestions.appendChild(option);
	});
}

function formatText(text) {
	return text.replace(/\{\{([^}]+)\}\}/g, (match, p1) => {
		const key = p1.toLowerCase();
		const ref = abilities[key] || mtgData.abilities[key];
		return ref ? `<span title="${ref.text}" style="text-decoration: underline dotted; cursor: help;">${p1}</span>` : p1;
	});
}

function showAbility(name) {
	const info = abilities[name];
	selectedAbility.innerText = name;

	let label = "";
	let textHtml = `<p>${formatText(info.text)}</p>`;

	if (info.type === "special") {
		label = `<span class='badge bg-dark text-white ms-2'>Special</span>`;
	} else if (mtgData.evergreen && mtgData.evergreen[name]) {
		label = `<span class='badge bg-success ms-2'>Evergreen</span>`;
	} else if (mtgData.arena && mtgData.arena[name]) {
		label = `<span class='badge bg-warning text-dark ms-2'>Arena-only</span>`;
	} else if (info.type === "abilityWord") {
		label = `<span class='badge bg-info ms-2'>Ability Word</span>`;
	} else if (info.type === "keywordAction") {
		label = `<span class='badge bg-primary ms-2'>Keyword Action</span>`;
	} else if (info.type === "keywordAbility") {
		label = `<span class='badge bg-secondary ms-2'>Keyword Ability</span>`;
	}

	if (info.image) {
		textHtml += `<br><img src="${info.image}" style="max-width: 200px; margin-top: 1rem;" />`;
	}

	abilityText.innerHTML = textHtml + label;
	abilityList.style.display = "none";
	abilityDetails.style.display = "block";
}

function resetView() {
	abilityInput.value = "";
	abilityDetails.style.display = "none";
	abilityList.style.display = "flex";
}

function filterAbilities() {
	const query = abilityInput.value.toLowerCase();
	const matchedKey = Object.keys(abilities).find(key => key.toLowerCase() === query);
	if (matchedKey) {
		showAbility(matchedKey);
	}
}
</script>

</body>
</html>
