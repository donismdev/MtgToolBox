<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>MTG Ability Finder</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
	<style>
		body {
			padding: 2rem;
			background-color: #f4f4f4;
			font-family: system-ui, sans-serif;
		}
		#searchSection {
			max-width: 800px;
			margin: 0 auto;
			position: relative;
		}
		#abilityInput {
			font-size: 1.5rem;
			padding: 1rem;
			height: 4rem;
			position: relative;
			z-index: 4;
			margin-bottom: 0.2rem;
		}
		#abilityList {
			margin-top: 2rem;
			display: flex;
			flex-wrap: wrap;
			gap: 0.5rem;
			justify-content: center;
		}
		.ability-badge {
			padding: 0.6rem 1rem;
			background-color: #e0e0e0;
			border-radius: 1rem;
			cursor: pointer;
			font-weight: 500;
			transition: background-color 0.2s;
		}
		.ability-badge:hover {
			background-color: #c0c0c0;
		}
		#divider {
			margin: 3rem 0 1rem 0;
			border-bottom: 2px solid #bbb;
		}
		#abilityDetails {
			display: none;
			margin-top: 2rem;
			text-align: center;
		}
		#resetBtn {
			margin-top: 0.5rem;
		}
		#customSuggestions {
			margin-top: 0.2rem;
			z-index: 3;
		}
	</style>
</head>
<body>
	<div id="searchSection">
		<input type="text" id="abilityInput" class="form-control mb-3" placeholder="Enter MTG ability keyword (e.g., trample, flash)" oninput="filterAbilities()" />
		<ul id="customSuggestions" class="list-group position-absolute w-100 z-3" style="top:100%; display: none;"></ul>
		<div id="divider"></div>
		<div id="abilityList"></div>
		<div id="abilityDetails">
			<h2 id="selectedAbility"></h2>
			<p id="abilityText" class="mt-3"></p>
			<button class="btn btn-secondary" id="resetBtn" onclick="resetView()">Reset</button>
		</div>
	</div>

<script>
const abilityList = document.getElementById("abilityList");
const abilityInput = document.getElementById("abilityInput");
const abilityDetails = document.getElementById("abilityDetails");
const selectedAbility = document.getElementById("selectedAbility");
const abilityText = document.getElementById("abilityText");
const suggestionBox = document.getElementById("customSuggestions");

let abilities = {};
window.mtgData = {};

fetch('abilities/ability_data.json')
	.then(res => res.json())
	.then(data => {
		window.mtgData = data;
		abilities = {
			...data.abilities,
			...data.evergreen,
			...data.arena
		};
		Object.entries(data.special).forEach(([name, text]) => {
			abilities[name] = {
				text: text,
				type: "special"
			};
		});
		renderAbilityList();
	});

function renderAbilityList() {
	abilityList.innerHTML = "";
	Object.keys(abilities).forEach(name => {
		const badge = document.createElement("div");
		badge.className = "ability-badge";
		badge.innerText = name;
		badge.onclick = () => showAbility(name);
		abilityList.appendChild(badge);
	});
}

function formatText(text) {
	return text.replace(/\{\{([^}]+)\}\}/g, (match, p1) => {
		const key = p1.toLowerCase();
		const ref = abilities[key] || mtgData.abilities[key];
		return ref ? `<span title="${ref.text}" style="text-decoration: underline dotted; cursor: help;">${p1}</span>` : p1;
	});
}

function showAbility(name) {
	suggestionBox.style.display = "none";

	const info = abilities[name];
	if (!info || !info.text) return;

	selectedAbility.innerText = name;

	let label = "";
	if (mtgData.evergreen && mtgData.evergreen[name]) {
		label = `<span class='badge bg-success ms-2'>Evergreen</span>`;
	} else if (mtgData.arena && mtgData.arena[name]) {
		label = `<span class='badge bg-warning text-dark ms-2'>Arena-only</span>`;
	} else if (info.type === "abilityWord") {
		label = `<span class='badge bg-info ms-2'>Ability Word</span>`;
	} else if (info.type === "keywordAction") {
		label = `<span class='badge bg-primary ms-2'>Keyword Action</span>`;
	} else if (info.type === "keywordAbility") {
		label = `<span class='badge bg-secondary ms-2'>Keyword Ability</span>`;
	} else if (info.type === "special") {
		label = `<span class='badge bg-dark text-white ms-2'>Special</span>`;
	}

	abilityText.innerHTML = formatText(`<p>${info.text}</p>` + label +
		(info.image ? `<br><img src="${info.image}" style="max-width: 200px; margin-top: 1rem;" />` : "")
	);
	abilityList.style.display = "none";
	abilityDetails.style.display = "block";
}

function resetView() {
	abilityInput.value = "";
	suggestionBox.style.display = "none";
	abilityDetails.style.display = "none";
	abilityList.style.display = "flex";
}

function filterAbilities() {
	const query = abilityInput.value.toLowerCase();
	const matchedKey = Object.keys(abilities).find(key => key.toLowerCase() === query);

	if (matchedKey) {
		showAbility(matchedKey);
		return;
	}

	const suggestions = Object.keys(abilities)
		.filter(key => key.toLowerCase().includes(query))
		.slice(0, 10);

	suggestionBox.innerHTML = "";
	if (suggestions.length === 0 || query === "") {
		suggestionBox.style.display = "none";
		return;
	}

	suggestions.forEach(name => {
		const li = document.createElement("li");
		li.className = "list-group-item list-group-item-action";
		li.innerText = name;
		li.onclick = () => {
			abilityInput.value = name;
			suggestionBox.style.display = "none";
			showAbility(name);
		};
		suggestionBox.appendChild(li);
	});

	suggestionBox.style.display = "block";
}
</script>
</body>
</html>
