<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Random MTG Card Picker</title>
	<style>
		body {
			font-family: sans-serif;
			background: #f4f4f4;
			padding: 2rem;
		}
		fieldset {
			border: 1px solid #ccc;
			border-radius: 6px;
			margin-bottom: 1rem;
			padding: 1rem;
		}
		legend {
			font-weight: bold;
		}
		#cardResult {
			margin-top: 2rem;
			text-align: center;
		}
		img.card-img {
			max-width: 300px;
			border-radius: 8px;
		}
		.toast {
			position: fixed;
			bottom: 20px;
			left: 50%;
			transform: translateX(-50%);
			background: #333;
			color: white;
			padding: 10px 20px;
			border-radius: 5px;
			opacity: 0;
			transition: opacity 0.3s ease;
			z-index: 999;
		}
		.toast.show {
			opacity: 1;
		}
		.filter-summary {
			margin-top: 1rem;
			padding: 1rem;
			background: #e8f5e9;
			border-left: 5px solid #4caf50;
			text-align: left;
			max-width: 500px;
			margin-left: auto;
			margin-right: auto;
		}
	</style>
</head>
<body>
	<h2>Random MTG Card Picker</h2>

	<form id="filterForm">
		<fieldset>
			<legend>Card Types</legend>
			<div style="margin-bottom: 0.5rem;">
				<label><input type="checkbox" id="wifiConfirm" /> <strong>Wi-Fi 연결됨 (데이터 사용 동의)</strong></label>
			</div>
			<label><input type="checkbox" name="type" value="Land"> Land</label>
			<label><input type="checkbox" name="type" value="Creature"> Creature</label>
			<label><input type="checkbox" name="type" value="Artifact"> Artifact</label>
			<label><input type="checkbox" name="type" value="Enchantment"> Enchantment</label>
			<label><input type="checkbox" name="type" value="Planeswalker"> Planeswalker</label>
			<label><input type="checkbox" name="type" value="Battle"> Battle</label>
			<label><input type="checkbox" name="type" value="Instant"> Instant</label>
			<label><input type="checkbox" name="type" value="Sorcery"> Sorcery</label>
		</fieldset>

		<fieldset>
			<legend>Colors</legend>
			<label><input type="checkbox" name="color" value="W"> White</label>
			<label><input type="checkbox" name="color" value="U"> Blue</label>
			<label><input type="checkbox" name="color" value="B"> Black</label>
			<label><input type="checkbox" name="color" value="R"> Red</label>
			<label><input type="checkbox" name="color" value="G"> Green</label>
		</fieldset>

		<fieldset>
			<legend>Rarity</legend>
			<label><input type="checkbox" name="rarity" value="common"> Common</label>
			<label><input type="checkbox" name="rarity" value="uncommon"> Uncommon</label>
			<label><input type="checkbox" name="rarity" value="rare"> Rare</label>
			<label><input type="checkbox" name="rarity" value="mythic"> Mythic</label>
		</fieldset>

		<fieldset>
			<legend>Legendary / Basic Land</legend>
			<label><input type="checkbox" id="legendaryOnly"> Legendary Only</label>
			<label><input type="checkbox" id="excludeBasic"> Exclude Basic Lands</label>
		</fieldset>

		<fieldset>
			<legend>Converted Mana Cost (CMC)</legend>
			<select id="cmcOperator">
				<option value="=">=</option>
				<option value="<=">&le;</option>
				<option value=">=">&ge;</option>
			</select>
			<input type="number" id="cmcValue" placeholder="CMC" />
		</fieldset>

		<button type="submit">Get Random Card</button>
	</form>

	<div id="cardResult"></div>
	<div class="toast" id="toastBox"></div>

	<script>
		function showToast(msg) {
			const toast = document.getElementById("toastBox");
			toast.textContent = msg;
			toast.classList.add("show");
			setTimeout(() => toast.classList.remove("show"), 3000);
		}

		document.getElementById("filterForm").addEventListener("submit", async function (e) {
			e.preventDefault();

			if (!document.getElementById("wifiConfirm").checked) {
				showToast("데이터 사용 동의가 필요합니다. Wi-Fi 연결을 권장합니다.");
				return;
			}

			let query = [];
			const form = e.target;

			// Types
			const typeList = Array.from(form.querySelectorAll("input[name='type']:checked")).map(cb => cb.value);
			if (typeList.length) query.push("type=" + typeList.map(encodeURIComponent).join(" OR "));

			// Colors
			const colorList = Array.from(form.querySelectorAll("input[name='color']:checked")).map(cb => cb.value);
			if (colorList.length) query.push("color>=" + colorList.join(""));

			// Rarity
			const rarityList = Array.from(form.querySelectorAll("input[name='rarity']:checked")).map(cb => cb.value);
			if (rarityList.length) query.push("rarity=" + rarityList.join("|"));

			// Legendary
			if (form.querySelector("#legendaryOnly").checked) query.push("is:legendary");

			// Exclude Basic Land
			if (form.querySelector("#excludeBasic").checked) query.push("-type:basic");

			// CMC
			const cmcRaw = form.querySelector("#cmcValue").value.trim();
			if (cmcRaw !== "") {
				const cmcOp = form.querySelector("#cmcOperator").value;
				query.push(`cmc${cmcOp}${cmcRaw}`);
			}

			const finalQuery = query.length ? `?q=${encodeURIComponent(query.join(" "))}` : "";
			const apiURL = `https://api.scryfall.com/cards/random${finalQuery}`;

			document.getElementById("cardResult").innerHTML = "<p>Loading...</p>";

			try {
				const res = await fetch(apiURL);
				const card = await res.json();

				let imgURL = card.image_uris?.normal || (card.card_faces ? card.card_faces[0].image_uris.normal : "");

				// 필터 요약
				let summary = [];
				if (typeList.length) summary.push("Types: " + typeList.join(", "));
				if (colorList.length) summary.push("Colors: " + colorList.join(", "));
				if (rarityList.length) summary.push("Rarity: " + rarityList.join(", "));
				if (form.querySelector("#legendaryOnly").checked) summary.push("Legendary Only");
				if (form.querySelector("#excludeBasic").checked) summary.push("Exclude Basic Lands");
				if (cmcRaw !== "") summary.push("CMC " + form.querySelector("#cmcOperator").value + " " + cmcRaw);

				// 이미지 객체 생성 (완전 로딩 확인 후 표시)
				const img = new Image();
				img.src = imgURL;
				img.className = "card-img";
				img.alt = card.name;

				img.onload = () => {
					let html = `<h3>${card.name}</h3>`;
					html += img.outerHTML;

					if (summary.length > 0) {
						html += `<div class="filter-summary"><strong>Filter:</strong><br>${summary.join("<br>")}</div>`;
					}

					const resultDiv = document.getElementById("cardResult");
					resultDiv.innerHTML = html;
					resultDiv.scrollIntoView({ behavior: "smooth", block: "start" });
				};
			} catch (err) {
				document.getElementById("cardResult").innerHTML = "<p>Failed to fetch card.</p>";
				console.error(err);
			}
		});
	</script>
</body>
</html>
