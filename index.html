<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>MtgToolBox</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
	<link rel="stylesheet" href="assets/style.css">
	<style>
	</style>
</head>
<body>
	<div class="d-flex">
		<div id="sidebar" class="d-flex flex-column flex-shrink-0 p-2 bg-light">
			<a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto link-dark text-decoration-none">
				<span class="fs-4">MtgToolBox</span>
			</a>
			<hr>
			<ul class="nav nav-pills flex-column mb-auto" id="tool-list"></ul>
			<hr>
			<div class="dropdown">
				<a href="#" class="d-flex align-items-center link-dark text-decoration-none dropdown-toggle" id="dropdownUser2" data-bs-toggle="dropdown" aria-expanded="false">
					<strong>v1.0.0</strong>
				</a>
				<ul class="dropdown-menu text-small shadow" aria-labelledby="dropdownUser2">
					<li><a class="dropdown-item" href="https://github.com/seonglae/MtgToolbox" target="_blank">GitHub</a></li>
				</ul>
			</div>
		</div>

		<div id="content" class="p-4">
			<h1 class="display-5">툴을 선택해주세요</h1>
			<p class="lead">왼쪽 사이드바에서 툴을 선택하여 시작하세요.</p>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	<script>
		const toolIndexUrl = "tool_index.json";
		const toolList = document.getElementById("tool-list");
		const content = document.getElementById("content");
		const adContainer = document.getElementById("ad-container");

		function getIconForTool(tool) {
			if (tool.tags?.includes("mtg")) return "bi-box-seam";
			if (tool.tags?.includes("csv")) return "bi-file-earmark-spreadsheet";
			if (tool.tags?.includes("json")) return "bi-file-earmark-code";
			if (tool.type === "html") return "bi-file-earmark-play";
			return "bi-tools";
		}

		function renderTool(tool) {
			let html = `
				<div class="card mb-3">
					<div class="card-header">
						<h2 class="card-title mb-0" title="${tool.description}">${tool.name}</h2>
					</div>
				</div>
			`;

			if (tool.type === "html") {
				const htmlPath = `${tool.path}${tool.name}.html`;
				html += `<iframe src="${htmlPath}" class="w-100 h-100 border-0"></iframe>`;
			} else {
				html += `<form id="toolForm">`;

				if (tool.inputs && Array.isArray(tool.inputs)) {
					tool.inputs.forEach(input => {
						html += `
							<div class="mb-3">
								<label for="${input.id}" class="form-label">${input.label}</label>
								<input type="${input.type}" class="form-control" id="${input.id}"
									${input.accept ? `accept="${input.accept}"` : ""}
									${input.default ? `value="${input.default}"` : ""}
								>
							</div>
						`;
					});
				}

				html += `</form>`;

				if (tool.path && tool.name && tool.download) {
					const zipPath = `${tool.path}${tool.name}.zip`;
					html += `<a href="${zipPath}" class="btn btn-primary" download>
								<i class="bi bi-download"></i> 다운로드 (.zip)
							 </a>`;
				}
			}

			content.className = 'pt-4 px-4 pb-4';
			content.innerHTML = html;

		}

		fetch(toolIndexUrl)
			.then(res => res.json())
			.then(data => {
				const toolsByParent = data.tools.reduce((acc, tool) => {
					const parent = tool.parent || "기타";
					if (!acc[parent]) acc[parent] = [];
					acc[parent].push(tool);
					return acc;
				}, {});

				Object.keys(toolsByParent).forEach(parent => {
					const parentLi = document.createElement("li");
					parentLi.className = "nav-item";
					const parentLink = document.createElement("a");
					parentLink.href = `#collapse-${parent.replace(/\s/g, '')}`;
					parentLink.className = "nav-link link-dark";
					parentLink.setAttribute("data-bs-toggle", "collapse");
					parentLink.setAttribute("aria-expanded", "true");
					parentLink.innerHTML = `<i class="bi bi-folder me-2"></i>${parent}<span class="ms-auto flex-shrink-0"><i class="bi bi-chevron-down collapse-icon"></i></span>`;
					parentLi.appendChild(parentLink);

					const subUl = document.createElement("ul");
					subUl.id = `collapse-${parent.replace(/\s/g, '')}`;
					subUl.className = "nav nav-pills flex-column ms-3 collapse show";

					subUl.addEventListener('show.bs.collapse', () => {
						parentLink.querySelector('.collapse-icon').classList.replace('bi-chevron-down', 'bi-chevron-up');
					});

					subUl.addEventListener('hide.bs.collapse', () => {
						parentLink.querySelector('.collapse-icon').classList.replace('bi-chevron-up', 'bi-chevron-down');
					});

					toolsByParent[parent].forEach(tool => {
						const item = document.createElement("li");
						item.className = "nav-item";
						const icon = getIconForTool(tool);

						const link = document.createElement('a');
						link.href = '#';
						link.className = 'nav-link link-dark';
						link.innerHTML = `<i class="bi ${icon} me-2"></i><span class="tool-link-text-container"><span class="tool-link-text">${tool.name}</span></span>`;
						item.appendChild(link);

						link.onclick = (e) => {
							e.preventDefault();
							const currentActive = document.querySelector('.nav-link.active-tool');
							if (currentActive) currentActive.classList.remove('active-tool');
							link.classList.add('active-tool');
							renderTool(tool);
						};

						subUl.appendChild(item);
					});

					parentLi.appendChild(subUl);
					toolList.appendChild(parentLi);
				});
			});
	</script>
</body>
</html>
