<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>MtgToolBox</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
	<link rel="stylesheet" href="assets/style.css">
</head>
<body>
	<div class="d-flex">
		<div id="sidebar" class="d-flex flex-column flex-shrink-0 p-2 bg-light">
			<a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto link-dark text-decoration-none">
				<span class="fs-4">MtgToolBox</span>
			</a>
			<hr>
			<ul class="nav nav-pills flex-column mb-auto" id="tool-list">
			</ul>
			<hr>
			<div class="dropdown">
				<a href="#" class="d-flex align-items-center link-dark text-decoration-none dropdown-toggle" id="dropdownUser2" data-bs-toggle="dropdown" aria-expanded="false">
					<strong>v0.0.1</strong>
				</a>
				<ul class="dropdown-menu text-small shadow" aria-labelledby="dropdownUser2">
					<li><a class="dropdown-item" href="https://github.com/seonglae/MtgToolbox" target="_blank">GitHub</a></li>
				</ul>
			</div>
		</div>

		<div id="content" class="p-4">
			<h1 class="display-5">툴을 선택해주세요</h1>
			<p class="lead">왼쪽 사이드바에서 툴을 선택하여 시작하세요.</p>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
	<script>
		const toolIndexUrl = "tool_index.json";
		const toolList = document.getElementById("tool-list");
		const content = document.getElementById("content");

		function getIconForTool(tool) {
			if (tool.tags?.includes("mtg")) return "bi-box-seam";
			if (tool.tags?.includes("csv")) return "bi-file-earmark-spreadsheet";
			if (tool.tags?.includes("json")) return "bi-file-earmark-code";
			if (tool.type === "html") return "bi-file-earmark-play";
			return "bi-tools";
		}

				function renderTool(tool) {
			let html = `
				<div class="card mb-3">
					<div class="card-header">
						<h2 class="card-title mb-0" title="${tool.description}">${tool.name}</h2>
					</div>
				</div>
			`;

			if (tool.type === "html") {
				const htmlPath = `${tool.path}${tool.name}.html`;
				html += `<iframe src="${htmlPath}" class="w-100 h-100 border-0"></iframe>`;
			} else {
				html += `<form id="toolForm">`;

				if (tool.inputs && Array.isArray(tool.inputs)) {
					tool.inputs.forEach(input => {
						html += `
							<div class="mb-3">
								<label for="${input.id}" class="form-label">${input.label}</label>
								<input type="${input.type}" class="form-control" id="${input.id}"
									${input.accept ? `accept="${input.accept}"` : ""}
									${input.default ? `value="${input.default}"` : ""}
								>
							</div>
						`;
					});
				}

				html += `</form>`;

				if (tool.path && tool.name && tool.download) {
					const zipPath = `${tool.path}${tool.name}.zip`;
					html += `<a href="${zipPath}" class="btn btn-primary" download>
								<i class="bi bi-download"></i> 다운로드 (.zip)
							 </a>`;
				}
			}

			content.className = 'pt-4 px-4 pb-4';
			content.innerHTML = html;

            // Custom Tooltip Logic
			const cardHeader = content.querySelector('.card-header');
			const titleElement = content.querySelector('.card-header h2');
			const tooltipText = titleElement.getAttribute('title');
			titleElement.removeAttribute('title');

			let customTooltip = document.querySelector('.custom-tooltip');
			if (!customTooltip) {
				customTooltip = document.createElement('div');
				customTooltip.className = 'custom-tooltip';
				document.body.appendChild(customTooltip);
			}

			if (cardHeader && tooltipText) {
				cardHeader.addEventListener('mousemove', (e) => {
					customTooltip.textContent = tooltipText;
					customTooltip.style.left = `${e.clientX + 15}px`;
					customTooltip.style.top = `${e.clientY + 15}px`;
				});

				cardHeader.addEventListener('mouseenter', () => {
					customTooltip.style.display = 'block';
				});

				cardHeader.addEventListener('mouseleave', () => {
					customTooltip.style.display = 'none';
				});
			}
		}

		fetch(toolIndexUrl)
			.then(res => res.json())
			.then(data => {
				const toolsByParent = data.tools.reduce((acc, tool) => {
					const parent = tool.parent || "기타";
					if (!acc[parent]) {
						acc[parent] = [];
					}
					acc[parent].push(tool);
					return acc;
				}, {});

				Object.keys(toolsByParent).forEach(parent => {
					const parentLi = document.createElement("li");
					parentLi.className = "nav-item";
					const parentLink = document.createElement("a");
					parentLink.href = `#collapse-${parent.replace(/\s/g, '')}`;
					parentLink.className = "nav-link link-dark";
					parentLink.setAttribute("data-bs-toggle", "collapse");
					parentLink.setAttribute("aria-expanded", "true");
					parentLink.innerHTML = `<i class="bi bi-folder me-2"></i>${parent}<span class="ms-auto flex-shrink-0"><i class="bi bi-chevron-down collapse-icon"></i></span>`;
					parentLi.appendChild(parentLink);

					const subUl = document.createElement("ul");
					subUl.id = `collapse-${parent.replace(/\s/g, '')}`;
					subUl.className = "nav nav-pills flex-column ms-3 collapse show";

					subUl.addEventListener('show.bs.collapse', function () {
						parentLink.querySelector('.collapse-icon').classList.remove('bi-chevron-down');
						parentLink.querySelector('.collapse-icon').classList.add('bi-chevron-up');
					});

					subUl.addEventListener('hide.bs.collapse', function () {
						parentLink.querySelector('.collapse-icon').classList.remove('bi-chevron-up');
						parentLink.querySelector('.collapse-icon').classList.add('bi-chevron-down');
					});
					toolsByParent[parent].forEach(tool => {
						const item = document.createElement("li");
						item.className = "nav-item";
						const icon = getIconForTool(tool);

						const link = document.createElement('a');
						link.href = '#';
						link.className = 'nav-link link-dark';
						link.innerHTML = `<i class="bi ${icon} me-2"></i><span class="tool-link-text-container"><span class="tool-link-text">${tool.name}</span></span>`;

						item.appendChild(link);

						const textSpan = link.querySelector('.tool-link-text');
						const containerSpan = link.querySelector('.tool-link-text-container');

						link.addEventListener('mouseenter', () => {
							if (textSpan.offsetWidth > containerSpan.offsetWidth) {
								const overflow = textSpan.offsetWidth - containerSpan.offsetWidth;
								const duration = overflow / 50; // 50px per second
								textSpan.style.transition = `transform ${duration}s linear`;
								textSpan.style.transform = `translateX(-${overflow}px)`;
							}
						});

						link.addEventListener('mouseleave', () => {
							textSpan.style.transition = 'transform 0.5s ease';
							textSpan.style.transform = 'translateX(0)';
						});

						link.onclick = (e) => {
							e.preventDefault();

							// 기존에 활성화된 툴의 하이라이트 제거
							const currentActive = document.querySelector('.nav-link.active-tool');
							if (currentActive) {
								currentActive.classList.remove('active-tool');
							}

							// 현재 클릭된 툴 하이라이트
							link.classList.add('active-tool');

							renderTool(tool);
						};
						subUl.appendChild(item);
					});
					parentLi.appendChild(subUl);
					toolList.appendChild(parentLi);
				});
			});
	</script>
</body>
</html>
