<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<meta name="color-scheme" content="only light" />
    <title>MtgToolBox</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <link rel="stylesheet" href="assets/style.css" />
    <style>
        /* --- 기본 레이아웃 --- */
		html {
			height: 100%;
			width: 100%;
			color-scheme: light;
			forced-color-adjust: none;
			-webkit-text-fill-color: currentColor;
		}

		body {
			margin: 0;
			padding: 0;
			min-height: 100%;
			background-color: #121212;
			color: #ffffff;
			overflow-x: hidden;
			touch-action: manipulation;
			-webkit-font-smoothing: antialiased;
			-moz-osx-font-smoothing: grayscale;
			-webkit-overflow-scrolling: touch;
		}

		:root {
			--vh: 1vh;
		}

		* {
			box-sizing: border-box;
		}

		/* ⬇️ 추가: 모바일 safe-area 대응 */
		@supports (padding-bottom: env(safe-area-inset-bottom)) {
			@media (hover: none) and (pointer: coarse) {
				body {
					padding-bottom: env(safe-area-inset-bottom);
				}
			}
		}

        body.modal-open {
            overflow: hidden;
            touch-action: none;
        }
        #content {
            padding: 2rem;
            margin-left: 0;
            min-height: 100vh;
        }

        /* --- 사이드바 --- */
        #sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 280px;
            height: 100vh;
            background-color: #f8f9fa;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            z-index: 1050;
            box-shadow: 2px 0 6px rgba(0, 0, 0, 0.2);
            padding: 1rem;
        }
        #sidebar.show {
            transform: translateX(0);
        }
        #sidebar .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            border: none;
            background: transparent;
            font-size: 1.5rem;
            color: #333;
        }
        #sidebar-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.3);
            z-index: 1040;
            display: none;
        }
        #sidebar-overlay.active {
            display: block;
        }

        /* --- ModalTool 전용 모달 --- */
        #modal-tool-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(50, 40, 40, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #modal-tool-content {
			background-color: white;
			height: calc(var(--vh, 1vh) * 100);
			max-height: none;
			padding-top: env(safe-area-inset-top);
			/* ⬇️ 수정: 불필요한 + 40px 제거 */
			padding-bottom: env(safe-area-inset-bottom, 0px); 
			border-radius: 5px;
			position: relative;
			width: 95vw;
			display: flex;
			flex-direction: column;
			overflow: hidden;
			overflow-y: auto;
			background-color: #121212;
		}
        #modal-tool-iframe {
            width: 100%;
            height: 100%;
            border: none;
            flex-grow: 1;
        }

        /* --- 오른쪽 고정 UI 버튼 --- */
        #fixed-ui-wrapper {
            position: fixed;
            top: 15px;
            right: 5px;
            z-index: 1200;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
            pointer-events: none; /* 래퍼는 클릭 이벤트를 통과시킴 */
        }

        /* 오른쪽 플로팅 버튼들을 담는 컨테이너 */
        #fixed-buttons-container {
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-end;
            transition: transform 0.35s ease-in-out;
            will-change: transform;
            margin-right: -10px;
        }
        #fixed-buttons-container.hidden-to-right {
            transform: translateX(200%);
        }

        /* ModalTool 버튼 / 사이드바 목록 버튼 공통 스타일 */
        .modal-tool-button, #toggleSidebarBtn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border: none;
            cursor: pointer;
            flex-shrink: 0;
            transform: scale(0.85);
            transition: transform 0.2s ease-in-out, background-color 0.2s ease, opacity 0.2s ease;
            pointer-events: auto; /* 버튼 자체는 클릭 가능해야 함 */
        }

        /* ModalTool 버튼 개별 스타일 */
        .modal-tool-button {
            font-size: 1.2rem;
            color: white;
        }

        #toggleSidebarBtn .bi-list {
            font-size: 1.8rem !important;
        }

        /* [상태] 마우스 오버 시 확대 */
        .modal-tool-button:hover,
        #toggleSidebarBtn:hover {
            transform: scale(1);
        }

        /* [상태] 활성화된 ModalTool 버튼 */
        .modal-tool-button.active-modal {
            transform: scale(1);
            box-shadow: 0 0 0 3px #fff, 0 0 0 5px rgba(0, 0, 0, 0.3);
            font-weight: bold;
        }

        /* [상태] 모달이 열렸을 때의 사이드바 버튼 (비활성화) */
        #toggleSidebarBtn.inactive-when-modal {
            transform: scale(0.85);
            background-color: #6c757d;
            border-color: #6c757d;
            opacity: 0.7;
            cursor: not-allowed;
        }
        #toggleSidebarBtn.inactive-when-modal:hover {
            transform: scale(0.85); /* 비활성화 시 hover 효과 제거 */
        }
        
        /* --- 확장 UI 메뉴 --- */
        #expanded-ui-container {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
            margin-bottom: 10px;
            transform-origin: bottom right;
            transition: transform 0.2s ease-out, opacity 0.2s ease-out;
            transform: scale(0); /* 기본 숨김 */
            opacity: 0;
            pointer-events: none;
        }
        #expanded-ui-container.show {
            transform: scale(1);
            opacity: 1;
            pointer-events: auto;
        }
        #expanded-ui-container .btn {
            width: 48px;
            height: 48px;
            transform: scale(0.85);
            pointer-events: auto;
        }

        /* 메인 UI 토글 버튼 (+) */
        #uiToggleBtn {
            width: 48px;
            height: 48px;
            font-size: 1.5rem;
            transition: transform 0.2s ease-out !important;
            pointer-events: auto;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer;
            border: none;
        }
        #uiToggleBtn.active {
            transform: rotate(45deg); /* 활성화 시 + 아이콘을 X로 회전 */
        }
        
        /* --- 사이드바 내부 툴 목록 --- */
        .nav-link.active-tool {
            background-color: var(--bs-primary);
            color: white !important;
            font-weight: bold;
        }
        .nav-link.active-tool::after {
            content: " ✓";
            margin-left: 6px;
            color: white;
        }

        /* --- 로딩 스피너 --- */
        #loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(18, 18, 18, 0.8);
            display: none; /* 평소에는 숨김 */
            justify-content: center;
            align-items: center;
            z-index: 2000; /* 최상단에 표시 */
        }
        .spinner {
            width: 56px;
            height: 56px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

		.modal-content {
			height: 100dvh;
			height: calc(var(--vh, 1vh) * 100); /* fallback */
			overflow-y: auto;
			background-color: #121212; /* 모달 배경도 명시! */
		}

		.fullscreen,
		[data-vh-fill="true"] {
			height: calc(var(--vh, 1vh) * 100);
		}

		/* ======================================= */
		/* == iOS 기기 전용 유사 전체화면 스타일 == */
		/* ======================================= */
		/* JavaScript에 의해 body에 'iOS'와 'pseudo-fullscreen' 클래스가 모두 있을 때만 동작합니다. */

		/* iOS 유사 전체화면 모드에서 플로팅 UI 버튼과 사이드바를 모두 숨깁니다. */
		body.iOS.pseudo-fullscreen #fixed-ui-wrapper,
		body.iOS.pseudo-fullscreen #sidebar,
		body.iOS.pseudo-fullscreen #sidebar-overlay {
			display: none !important;
		}

		/* iOS 유사 전체화면 모드에서 메인 콘텐츠 영역의 여백을 없애고 화면에 꽉 채웁니다. */
		body.iOS.pseudo-fullscreen #content {
			padding: 0;
			margin: 0;
			height: 100vh;
			width: 100vw;
		}

		/* iOS 유사 전체화면 모드에서 툴 제목(H1 태그)을 숨깁니다. */
		body.iOS.pseudo-fullscreen #content > h1 {
			display: none;
		}

		/* iOS 유사 전체화면 모드에서 내부 iframe의 크기를 100%로 확장하고 테두리를 제거합니다. */
		body.iOS.pseudo-fullscreen #content #embedded-tool-iframe {
			height: 100%;
			width: 100%;
			border-radius: 0;
		}

		body.iOS #modal-tool-content {
			/* env()를 지원하지 않는 구형 브라우저를 위해 fallback 값(20px)을 줄 수 있습니다. */
			padding-bottom: calc(env(safe-area-inset-bottom, 20px) + 40px);
		}
    </style>
</head>
<body>
    <div id="sidebar-overlay" onclick="toggleSidebar(false)"></div>
    <div id="sidebar">
        <button class="close-btn" onclick="toggleSidebar(false)">&times;</button>
        <a href="/" class="d-flex align-items-center mb-3 link-dark text-decoration-none">
            <span class="fs-4">MtgToolBox</span>
        </a>
        <hr />
        <ul class="nav nav-pills flex-column mb-auto" id="tool-list-container"></ul>
        <hr />
        <div class="dropdown">
            <a href="#" class="d-flex align-items-center link-dark text-decoration-none dropdown-toggle" id="dropdownUser2" data-bs-toggle="dropdown" aria-expanded="false">
                <strong>v1.0.0</strong>
            </a>
            <ul class="dropdown-menu text-small shadow" aria-labelledby="dropdownUser2">
                <li><a class="dropdown-item" href="https://github.com/seonglae/MtgToolbox" target="_blank">GitHub</a></li>
            </ul>
        </div>
    </div>

    <div id="content">
        <h1 class="display-5 text-light">툴을 선택해주세요</h1>
        <p class="lead text-light">왼쪽 목차를 열어 툴을 선택하세요.</p>
    </div>

    <div id="fixed-ui-wrapper">
        <div id="expanded-ui-container">
            <button id="hideButtonsBtn" class="btn btn-light rounded-circle shadow" title="플로팅 버튼 숨기기/표시">
                <i class="bi bi-box-arrow-right"></i>
            </button>
            <button id="fullscreenBtn" class="btn btn-secondary rounded-circle shadow" title="전체화면">
                <i class="bi bi-arrows-fullscreen"></i>
            </button>
        </div>

        <button id="uiToggleBtn" class="btn btn-info text-white rounded-circle shadow">
            <i class="bi bi-plus-lg"></i>
        </button>
        
        <div id="fixed-buttons-container">
            <button id="toggleSidebarBtn" class="btn btn-primary rounded-circle shadow">
                <i class="bi bi-list fs-4"></i>
            </button>
            </div>
    </div>

    <div id="modal-tool-overlay">
      <div id="modal-tool-content">
        <iframe id="modal-tool-iframe" src=""></iframe>
      </div>
    </div>

    <div id="loader-overlay">
        <div class="spinner"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- 전역 변수 및 상수 정의 ---
    window.session_data = {};
    const toolIndexUrl = "tool_index.json";

    // --- DOM 요소 캐싱 ---
    const toolListContainer = document.getElementById("tool-list-container");
    const contentArea = document.getElementById("content");
    const loaderOverlay = document.getElementById('loader-overlay');
    
    // ModalTool 관련 요소
    const modalToolOverlay = document.getElementById('modal-tool-overlay');
    const modalTool = document.getElementById('modal-tool-iframe');
    
    // 사이드바 관련 요소
    const sidebar = document.getElementById("sidebar");
    const sidebarOverlay = document.getElementById("sidebar-overlay");
    const toggleSidebarBtn = document.getElementById('toggleSidebarBtn');
    
    // 오른쪽 UI 관련 요소
    const fixedButtonsContainer = document.getElementById('fixed-buttons-container');
    const uiToggleBtn = document.getElementById('uiToggleBtn');
    const expandedUiContainer = document.getElementById('expanded-ui-container');
    const hideButtonsBtn = document.getElementById('hideButtonsBtn');
    const fullscreenBtn = document.getElementById('fullscreenBtn');

    // --- 상태 관리 변수 ---
    let currentOpenModalUrl = null;
    const modalToolDisplayNameMap = {}; // { "url": "icon" } 형식으로 ModalTool 버튼의 텍스트 저장
    const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

    // --- 초기화 ---
    history.replaceState({ modal: false }, '', location.href);
    toggleSidebar(true); // 페이지 로드 시 사이드바를 기본으로 표시

	// 페이지 로드 시 기기를 감지하여 iOS일 경우 body에 'iOS' 클래스를 추가합니다.
	if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
		document.body.classList.add('iOS');
	}

    // ===================================================================================
    // ✨ 리팩토링 핵심 개념 ✨
    // 1. EmbeddedTool: 사이드바 목록에서 선택하여 메인 콘텐츠 영역(#content)에 그려지는 툴
    // 2. ModalTool: 화면 오른쪽의 플로팅 버튼을 눌러 전체 화면 모달(#modal-tool-overlay)로 로드되는 툴.
    // ===================================================================================

    // --- 사이드바 및 UI 상태 관리 함수 ---

    /** 사이드바를 열거나 닫습니다. */
    function toggleSidebar(show) {
        if (show) {
            sidebar.classList.add("show");
            sidebarOverlay.classList.add("active");
        } else {
            sidebar.classList.remove("show");
            sidebarOverlay.classList.remove("active");
        }
    }

    /** 확장 UI 메뉴를 열거나 닫습니다. */
    function toggleUiExpansion(forceHide = false) {
        const isActive = expandedUiContainer.classList.contains('show');
        if (forceHide || isActive) {
            expandedUiContainer.classList.remove('show');
            uiToggleBtn.classList.remove('active');
        } else {
            expandedUiContainer.classList.add('show');
            uiToggleBtn.classList.add('active');
        }
    }

    // --- 툴 렌더링 및 관리 함수 ---

    /**
     * tool.json 객체를 기반으로 사이드바에 표시할 아이콘을 결정합니다.
     * @param {object} tool - 툴 정보 객체
     * @returns {string} Bootstrap 아이콘 클래스명
     */
    function getIconForTool(tool) {
        if (tool.tags?.includes("mtg")) return "bi-box-seam";
        if (tool.tags?.includes("csv")) return "bi-file-earmark-spreadsheet";
        if (tool.tags?.includes("json")) return "bi-file-earmark-code";
        // EmbeddedTool 타입은 재생 아이콘을 사용합니다.
        if (tool.type === "html" || (Array.isArray(tool.type) && tool.type.includes("html"))) return "bi-file-earmark-play";
        return "bi-tools"; // 기본 아이콘
    }

    /**
     * 메인 콘텐츠 영역(#content)에 EmbeddedTool을 렌더링합니다.
     * @param {object} tool - 렌더링할 툴 정보 객체
     */
    function renderEmbeddedTool(tool) {
        loaderOverlay.style.display = 'flex'; // 로딩 시작

        // 만약 ModalTool이 열려있다면 먼저 닫습니다.
        if (modalToolOverlay.style.display === 'flex') {
            closeModalTool(false);
        }

        let html = "";
		if (tool.hide_header !== true) {
			html += `<h1 class="display-5 text-light mb-4">${tool.name}</h1>`;
		}
        let isIframe = false;

        // 툴 타입이 'html' (EmbeddedTool)인 경우 iframe으로 렌더링합니다.
        if (tool.type === "html" || (Array.isArray(tool.type) && tool.type.includes("html"))) {
            const htmlPath = `${tool.path}${tool.name}.html`;
            html += `<iframe id="embedded-tool-iframe" src="${htmlPath}" class="w-100" style="height: 100%; border: none; border-radius: 8px;"></iframe>`;
            isIframe = true;
        } else {
            // 다른 타입의 툴 (예: 폼 기반)은 여기에 렌더링 로직을 추가할 수 있습니다.
            // (기존 로직 유지)
        }

        contentArea.innerHTML = html;
        toggleSidebar(false); // 툴을 선택하면 사이드바를 닫습니다.


        if (isIframe) {
            const embeddedToolIframe = document.getElementById('embedded-tool-iframe');
            // iframe 로드가 완료되면 로딩 오버레이를 숨깁니다.

			const iframeWindow = embeddedToolIframe.contentWindow; 

            embeddedToolIframe.onload = () => {
                loaderOverlay.style.display = 'none';

				if (iframeWindow && typeof iframeWindow.onEmbeddedOpen === 'function') {
                    iframeWindow.onEmbeddedOpen();
                }
            };
            // 안전장치: 8초 후에도 로딩이 완료되지 않으면 강제로 로더를 숨깁니다.
            setTimeout(() => {
                if (loaderOverlay.style.display === 'flex') {
                    loaderOverlay.style.display = 'none';
                }
            }, 8000);
        } else {
            // iframe이 아닌 툴은 즉시 로딩 오버레이를 숨깁니다.
            loaderOverlay.style.display = 'none';
        }

        // 렌더링 후 화면 상단으로 스크롤합니다.
        setTimeout(() => window.scrollTo(0, 0), 10);
    }
    
    /**
     * ModalTool을 열고 관련 UI 상태를 업데이트합니다.
     * @param {string} fullUrl - 로드할 ModalTool의 전체 URL
     * @param {object} tool - ModalTool 정보 객체
     */
    function openModalTool(fullUrl, tool) {
        // 이미 같은 ModalTool이 열려있으면 닫습니다.
        if (modalToolOverlay.style.display === 'flex' && currentOpenModalUrl === fullUrl) {
            closeModalTool();
            return;
        }
        
        loaderOverlay.style.display = 'flex'; // 로딩 시작

        // iframe 로드가 완료되면 로더를 숨기고 모달을 표시합니다.
        modalTool.onload = () => {
            loaderOverlay.style.display = 'none';
            modalToolOverlay.style.display = 'flex';

            // 모달 내부의 onModalOpen 함수가 있다면 호출합니다.
            try {
                const iframeWindow = modalTool.contentWindow;
                if (iframeWindow && typeof iframeWindow.onModalOpen === 'function') {
                    iframeWindow.onModalOpen();
                }
            } catch (e) {
                console.error("Iframe 접근 오류:", e);
            }
        };

        // 모달을 열기 전 UI 상태를 설정합니다.
        toggleSidebar(false);
        toggleSidebarBtn.classList.add('inactive-when-modal'); // 사이드바 버튼 비활성화
        document.body.classList.add('modal-open');
        currentOpenModalUrl = fullUrl;
        updateModalToolButtonStates(fullUrl); // 활성 ModalTool 버튼 스타일 업데이트

        // 브라우저 history에 모달 상태를 추가합니다 (뒤로가기 지원).
        if (!history.state?.modal) {
            history.pushState({ modal: true }, '', '');
        }

        // 마지막으로 iframe의 src를 설정하여 로딩을 시작합니다.
        modalTool.src = fullUrl;
    }

    /**
     * 현재 열려있는 ModalTool을 닫습니다.
     * @param {boolean} pushStateBack - 브라우저 history를 뒤로 돌릴지 여부
     */
    function closeModalTool(pushStateBack = true) {
        modalTool.onload = null; // onload 핸들러 초기화

        // 모달 내부의 onModalClose 함수가 있다면 호출합니다.
        try {
            const iframeWindow = modalTool.contentWindow;
            if (iframeWindow && typeof iframeWindow.onModalClose === 'function') {
                iframeWindow.onModalClose();
            }
        } catch (e) {
            console.error("Iframe 접근 오류:", e);
        }

        // UI 상태를 원래대로 복원합니다.
        toggleSidebarBtn.classList.remove('inactive-when-modal');
        modalToolOverlay.style.display = 'none';
        document.body.classList.remove('modal-open');
        modalTool.src = 'about:blank'; // ModalTool 비우기
        clearActiveModalToolButtonState(); // 모든 ModalTool 버튼 활성 상태 해제
        currentOpenModalUrl = null;

        // history.back()으로 닫는 경우를 처리합니다.
        if (pushStateBack && history.state?.modal) {
            history.back();
        }
    }


    // --- UI 상태 업데이트 함수 ---

    /** 사이드바에서 현재 선택된 EmbeddedTool의 활성 상태를 해제합니다. */
    function clearActiveListSelection() {
        const currentActive = document.querySelector('.nav-link.active-tool');
        if (currentActive) currentActive.classList.remove('active-tool');
    }
    
    /** 모든 ModalTool 버튼의 활성 상태(테두리, 아이콘)를 초기화합니다. */
    function clearActiveModalToolButtonState() {
        document.querySelectorAll('.modal-tool-button').forEach(btn => {
            btn.classList.remove('active-modal');
            btn.textContent = modalToolDisplayNameMap[btn.dataset.modalUrl]; // 원래 아이콘으로 복원
        });
    }
    
    /**
     * 주어진 URL에 해당하는 ModalTool 버튼을 활성화하고 나머지는 비활성화합니다.
     * @param {string} activeUrl - 활성화할 ModalTool의 URL
     */
    function updateModalToolButtonStates(activeUrl) {
        document.querySelectorAll('.modal-tool-button').forEach(btn => {
            if (btn.dataset.modalUrl === activeUrl) {
                btn.classList.add('active-modal');
                btn.textContent = '✓'; // 활성 상태 아이콘
            } else {
                btn.classList.remove('active-modal');
                btn.textContent = modalToolDisplayNameMap[btn.dataset.modalUrl]; // 원래 아이콘
            }
        });
    }

    // --- 전체화면 관리 ---
    function toggleFullScreen() {
		// body에 'iOS' 클래스가 있는지 확인하여 아이폰 계열 기기인지 판단
		const isIOSDevice = document.body.classList.contains('iOS');
		const fullscreenIcon = fullscreenBtn.querySelector('i');

		// iOS 기기일 경우: CSS 클래스를 이용한 유사 전체화면 모드 토글
		if (isIOSDevice) {
			const isPseudoFullscreen = document.body.classList.toggle('pseudo-fullscreen');
			
			// 아이콘 상태를 직접 업데이트
			fullscreenIcon.classList.toggle('bi-arrows-fullscreen', !isPseudoFullscreen);
			fullscreenIcon.classList.toggle('bi-arrows-angle-contract', isPseudoFullscreen);

		} else { // 그 외 기기(안드로이드, PC)일 경우: 표준 전체화면 API 사용
			if (!document.fullscreenElement) {
				document.documentElement.requestFullscreen().catch(err => {
					alert(`전체화면 모드를 시작할 수 없습니다: ${err.message}`);
				});
			} else {
				if (document.exitFullscreen) document.exitFullscreen();
			}
		}
		toggleUiExpansion(true); // 기능 실행 후 확장 메뉴 닫기
	}

    // --- 이벤트 리스너 설정 ---

    // 확장 UI 토글 버튼
    uiToggleBtn.addEventListener('click', () => toggleUiExpansion());

    // 플로팅 버튼 숨기기/표시 버튼
    hideButtonsBtn.addEventListener('click', () => {
        const icon = hideButtonsBtn.querySelector('i');
        const isHidden = fixedButtonsContainer.classList.toggle('hidden-to-right');
        icon.classList.toggle('bi-box-arrow-right', !isHidden);
        icon.classList.toggle('bi-box-arrow-left', isHidden);
        toggleUiExpansion(true); // 메뉴 닫기
    });

    // 사이드바 목록 토글 버튼
    toggleSidebarBtn.addEventListener('click', () => {
        if (toggleSidebarBtn.classList.contains('inactive-when-modal')) return; // 모달 열렸을 땐 동작 안함
        toggleUiExpansion(true); // 확장 메뉴 먼저 닫기
        toggleSidebar(!sidebar.classList.contains("show"));
    });

    // 전체화면 버튼
    fullscreenBtn.addEventListener('click', toggleFullScreen);
    document.addEventListener('fullscreenchange', () => {
		const isFullscreen = !!document.fullscreenElement;
		const fullscreenIcon = fullscreenBtn.querySelector('i');
		fullscreenIcon.classList.toggle('bi-arrows-fullscreen', !isFullscreen);
		fullscreenIcon.classList.toggle('bi-arrows-angle-contract', isFullscreen);
	});

    // 모달 오버레이 클릭 시 닫기
    modalToolOverlay.addEventListener('click', (event) => {
        if (event.target === modalToolOverlay) closeModalTool(true);
    });

    // 브라우저 뒤로가기 버튼으로 모달 닫기
    window.addEventListener('popstate', (event) => {
        if (!event.state?.modal && modalToolOverlay.style.display === 'flex') {
            closeModalTool(false);
        }
    });

    // 초기 화면에서 콘텐츠 영역 클릭 시 사이드바 열기
    contentArea.addEventListener('click', () => {
        const h1 = contentArea.querySelector('h1');
        if (h1 && h1.textContent === '툴을 선택해주세요') {
            toggleSidebar(true);
        }
    });

    // --- 데이터 로딩 및 동적 UI 생성 ---

    fetch(toolIndexUrl)
        .then(res => res.json())
        .then(data => {
            // 활성화된 툴만 필터링 (플랫폼 조건 포함)
            const enabledTools = data.tools.filter(tool => {
                if (tool.enable === false) return false;
                if (tool.mobileOnly === true && !isMobile) return false;
                if (tool.desktopOnly === true && isMobile) return false;
                return true;
            });

            // 1. ModalTool 버튼 생성
            const modalTools = enabledTools.filter(tool => tool.type === 'html_modal' || (Array.isArray(tool.type) && tool.type.includes('html_modal')));
            modalTools.forEach(tool => {
                const fullUrl = `${tool.path}${tool.name}.html?modal=true`;
                const displayName = tool.modalIcon || tool.name;
                modalToolDisplayNameMap[fullUrl] = displayName; // 아이콘/텍스트 정보 저장

                const button = document.createElement('button');
                button.className = 'btn modal-tool-button';
                button.textContent = displayName;
                button.dataset.modalUrl = fullUrl;
                button.title = tool.name;
                if (tool.modalIconColor) {
                    button.style.backgroundColor = tool.modalIconColor;
                }

                button.onclick = () => {
                    toggleUiExpansion(true); // 버튼 클릭 시 확장 메뉴는 닫기
                    openModalTool(fullUrl, tool);
                };
                
                fixedButtonsContainer.appendChild(button);
            });
            
            // 2. EmbeddedTool 및 기타 툴 목록 (사이드바) 생성
            const toolsByParent = enabledTools.reduce((acc, tool) => {
                const parent = tool.parent || "기타";
                if (!acc[parent]) acc[parent] = [];
                acc[parent].push(tool);
                return acc;
            }, {});

            Object.keys(toolsByParent).forEach(parent => {
                const parentLi = document.createElement("li");
                parentLi.className = "nav-item";
                parentLi.innerHTML = `
                    <a href="#collapse-${parent.replace(/\s/g, '')}" class="nav-link link-dark" data-bs-toggle="collapse" aria-expanded="true">
                        <i class="bi bi-folder me-2"></i>${parent}
                        <span class="ms-auto flex-shrink-0"><i class="bi bi-chevron-down collapse-icon"></i></span>
                    </a>
                `;
                
                const subUl = document.createElement("ul");
                subUl.id = `collapse-${parent.replace(/\s/g, '')}`;
                subUl.className = "nav nav-pills flex-column ms-3 collapse show";
                
                toolsByParent[parent].forEach(tool => {
                    const item = document.createElement("li");
                    item.className = "nav-item";
                    
                    const link = document.createElement('a');
                    link.href = '#';
                    link.className = 'nav-link link-dark';
                    link.innerHTML = `<i class="bi ${getIconForTool(tool)} me-2"></i>${tool.name}`;
                    
                    link.onclick = (e) => {
                        e.preventDefault();
                        clearActiveModalToolButtonState(); // 다른 툴 선택 시 ModalTool 활성 상태 해제
                        clearActiveListSelection(); // 기존 선택 해제
                        link.classList.add('active-tool'); // 현재 툴 활성
                        renderEmbeddedTool(tool); // EmbeddedTool 렌더링
                    };

                    item.appendChild(link);
                    subUl.appendChild(item);
                });

                if (toolsByParent[parent].length > 0) {
                    parentLi.appendChild(subUl);
                    toolListContainer.appendChild(parentLi);
                }
            });
        });

		function updateVh() {
			const vh = window.innerHeight * 0.01;
			document.documentElement.style.setProperty('--vh', `${vh}px`);
		}

		window.addEventListener('load', updateVh);
		window.addEventListener('resize', updateVh);

</script>
</body>
</html>